---
- hosts: nano_hs
  remote_user: ec2-user
  tasks:
    - name: Install docker
      yum:
        name: docker
        state: present
      become: true

    - name: Add user to docker group
      user:
        name: "ec2-user"
        groups: 'docker'
        append: 'yes'
      become: true

    - name: Ensure docker deamon restart
      service:
        name: docker
        state: restarted
      become: true

    - name: Install docker stack/swarm deps
      pip:
        name:
          - jsondiff
          - pyyaml
          - docker
      become: true

    - name: Init the swarm
      docker_swarm:
        state: present
        default_addr_pool: "172.0.0.0/16"

    - name: Deploy Nano Stack 
      docker_stack:
        state: present
        name: nano_hs_stack
        compose:
          - version: '3'
            services:
              bot:
                image: jeovazero/pepe-haskeller:latest
                environment:
                    BOT_TOKEN: "{{ lookup('env', 'BOT_TOKEN') }}"
